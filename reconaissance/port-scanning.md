## Port Scanning 
#### nmap
```bash 
# Nmap fastest 
nmap 10.11.1.111 --max-retries 1 --min-rate 1000 
nmap -Pn -p- -A -T4 10.11.1.111

# Nmap all ports 
nmap -p- -Pn -n 10.10.10.10 -oA 
nmap -vv --reason -Pn -A --osscan-guess --version-all -p (when others exhausted) 

# Nmap top ports 
Nmap -Pn -sV --top-ports 100 -iL ips.txt -oA portscan_active 
nmap --top-ports 200 -sV -n --max-retries 2 -Pn --open -iL ips.txt -oA portscan_active

# Nmap full scan (slow) 
nmap -v -A -p- -Pn --script vuln -oA full 10.11.1.111

# Nmap stealth 
Nmap -sS 10.10.10.10 
Nmap -sS -sV -iL live-hosts.txt
Nmap -sS -sV -p XX 10.10.10.10

# Nmap banner grabbing  
nmap -pXX,XX,XX,XX,XX -Pn -sV -n 10.10.10.10

# Nmap active OS fingerprinting
nmap -O -n 10.10.10.10
nmap -O -A 10.10.10.10

# Nmap UDP 
nmap 10.11.1.111 -sU
nmap -sU -F -Pn -v -d -sC -sV --open --reason -T5 10.11.1.111

# Nmap web discovery 
nmap -p 80,443,8000,8080,8180,8888,1000 --open

# Nmap filtering evasion 
nmap -f <IP>
nmap --mtu 24 <IP> 
nmap --data-length 30 <IP> -  Appending random data into packet header (ex. 30 extra bytes) 
nmap --source-port 53 <IP> - Running port scan through specific port (ex. DNS) 

# Nmap fragmented evasion 
Nmap -f -sS 10.11.1.111 -p XX -Pn -n --disable-arp-ping

# Nmap decoy scans
nmap -p <port> -D <real_IP>,ME,<fakeIP><fakeIP>
nmap -D RND:10<IP> -sS -p <port> -Pn --disable-arp-ping
hping3 --rand-source -S -p <port> <IP> -c 3 

# Nmap better speed flags
--max-rtt-timeout: Time response per probe
--script-timeout: Time response per script
--host-timeout: Time response for host
--open: Avoid detection if filtered or closed
--min-rate

# Nmap Automator 
sudo nmapAutomator.sh 10.11.1.111 Basic [UDP, All, Full, Vulns]

# Nmap vuln scan 
locate nmap/scripts | grep $service
nmap -pXX -vv -sV --script vuln 10.11.1.111
nmap -p --script safe -Pn -n 10.10.10.10
nmap -p --script default -Pn -n 10.10.10.10
```
![image](https://github.com/GwenBSec/Pentest-Book/assets/88676386/024e79ae-e9e7-466a-94a2-fe35201326e7)

#### rustscan 
```bash
# all port scan  
rustscan -a IP -r 1-65535

# batch size 1000
rustscan -a IP -r 1-65535 -b 1000 --ulimit 5000
```

#### nmap-parse-output 
```bash
# https://github.com/ernw/nmap-parse-output
./nmap-parse-output scan-ouput.xml hosts
./nmap-parse-output scan-ouput.xml ports
./nmap-parse-output scan-ouput.xml port-info
./nmap-parse-output scan-ouput.xml service-names
./nmap-parse-output scan-ouput.xml service mysql
```

#### shodan 
```bash
https://cli.shodan.io/
shodan host 151.101.1.68
```

#### PowerShell 
```powershell
# check single port w/ single IP 
Test-NetConnection -Port 80 192.168.1.1

# check single port in IP range
foreach ($ip in 1..20) {Test-NetConnection -Port 80 -InformationLevel "Detailed" 192.168.1.$ip}

# check port list (80,443,8080,etc.)
80,443,8080 | % {echo ((new-object Net.Sockets.TcpClient).Connect(“192.168.1.1”,$_)) “Port $_ is open!”} 2>$null

# port scan
1..1024 | % {echo ((new-object Net.Sockets.TcpClient).Connect("10.0.0.100",$_)) "Port $_ is open!"} 2>$null
```

```powershell
# port-scan script
$targetservers = "192.168.122.241", "192.168.122.1"

$ports = "22","23","80","443","9100"

$result = @()

foreach ($target in $targetservers) {

    foreach ($port in $ports) {

        $obj = new-Object system.Net.Sockets.TcpClient

        $connect = $obj.BeginConnect($target,$port,$null,$null)

        $Wait = $connect.AsyncWaitHandle.WaitOne(100,$false)

        If (-Not $Wait) {

            write-host $target 'port' $port 'Closed - Timeout'

        }

        else {

            $value = "Open"

            write-host $target 'port' $port $value

            $r = new-object -type psobject

            $r | add-member -membertype noteproperty -name host -value $target

            $r | add-member -membertype noteproperty -name port -value $port

            $r | add-member -membertype noteproperty -name state -value $value

            $result += $r

        }

    }

}
PS L:\> $result
```
 
